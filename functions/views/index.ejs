<%- include('reusables/nav') %>

<% 
// Pagination configuration
const productsPerPage = 36; // Increased products per page like AliExpress
const currentPage = locals.currentPage || 1;
const totalProducts = locals.totalProducts || products.length;
const totalPages = locals.totalPages || Math.ceil(totalProducts / productsPerPage);

// If the backend doesn't handle pagination, we can simulate it client-side
const paginatedProducts = locals.paginatedProducts || products.slice((currentPage - 1) * productsPerPage, currentPage * productsPerPage);

// Featured categories for the top banner
const featuredCategories = [
  { name: 'Electrónica', icon: 'mobile-alt' },
  { name: 'Moda', icon: 'tshirt' },
  { name: 'Hogar', icon: 'home' },
  { name: 'Belleza', icon: 'spa' },
  { name: 'Deportes', icon: 'futbol' },
  { name: 'Juguetes', icon: 'gamepad' },
  { name: 'Automóvil', icon: 'car' },
  { name: 'Herramientas', icon: 'tools' }
];

// Flash deals for the deals section
const flashDeals = paginatedProducts.slice(0, 6);

// Helper function to format numbers with commas for thousands
function formatNumber(num) {
  return num > 999 ? (num/1000).toFixed(0) + ',' + (num % 1000).toString().padStart(3, '0') : num;
}

function getBadges(product) {
    const badges = [];

    if (!product || typeof product.discount !== 'number') return badges;

    if (product.discount >= 50) {
      badges.push({ type: 'SuperOfertas', class: 'bg-red-600 text-white' });
      badges.push({ type: 'Big Save', class: 'bg-blue-600 text-white' });
    } else if (product.discount > 0) {
      badges.push({ type: 'Promo', class: 'bg-yellow-500 text-black' });
    }

    return badges;
  }
%>

<!-- Top Picks For You -->
<section class="py-8 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Recomendados para ti</h2>
      <div class="flex space-x-2">
        <button class="prev-btn bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-sm hover:bg-gray-100">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="next-btn bg-white rounded-full w-8 h-8 flex items-center justify-center shadow-sm hover:bg-gray-100">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-2">

      <% paginatedProducts.slice(0, 12).forEach(product => {
        // Etiquetas
        const badges = getBadges(product);
        // Descuento
        const hasDiscount = product.discount;
        const originalPrice = hasDiscount ? (product.price * (1 + (product.discount/100))).toFixed(2) : null;
        // Estrellas
        const stars = Array.isArray(product.stars) ? product.stars : [];
        const totalStars = stars.reduce((acc, val) => acc + val, 0);
        const rating = stars.length > 0 ? (totalStars / stars.length) : 0;
      %>
        <div class="bg-white overflow-hidden rounded-lg shadow-sm hover:shadow-md transition-all hover:border hover:border-1 flex flex-col h-full group relative">
          <!-- Product Image -->
          <div class="relative aspect-square overflow-hidden bg-gray-100">
            <a href="/product/<%= product.id %>">
              <img 
                src="<%= product.image %>" 
                alt="<%= product.name %>" 
                class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
              >
            </a>
            
            <!-- Discount badge -->
            <% if (hasDiscount) { %>
              <div class="absolute top-0 left-0 bg-red-600 text-white text-xs font-bold px-2 py-1">
                -<%= product.discount %>%
              </div>
            <% } %>
            
            <!-- Add to cart button (circular) -->
            <button onclick="addToCart('<%= product.id %>')" class="absolute bottom-2 right-2 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <i class="fas fa-shopping-cart text-gray-700"></i>
            </button>
          </div>
          
          <!-- Product Info -->
          <div class="p-3 flex-grow">
            <!-- Etiquetas -->
            <% if (badges.length > 0) { %>
              <div class="flex flex-wrap gap-1 mb-1">
                <% badges.forEach(badge => { %>
                  <span class="text-xs px-1.5 py-0.5 rounded <%= badge.class %>"><%= badge.type %></span>
                <% }); %>
              </div>
            <% } %>
            
            <!-- Product Title -->
            <h3 class="text-sm leading-tight mb-2 line-clamp-2">
              <a href="/product/<%= product.id %>" class="hover:text-red-600"><%= product.name %></a>
            </h3>
            
            <!-- Pricing -->
            <div class="flex items-center">
              <span class="text-red-600 font-bold"><small>PEN </small><%= product.price.toFixed(2) %></span>
              <% if (hasDiscount) { %>
                <span class="ml-2 text-xs text-gray-500 line-through">S/<%= originalPrice %></span>
              <% } %>
            </div>
            
            <!-- Shipping & Rating -->
            <div class="mt-2 flex items-center text-xs text-gray-500">
              <div class="flex items-center">
                <i class="fas fa-star text-yellow-400"></i>
                <span class="ml-1"><%= rating.toFixed(1) %></span>
              </div>
              <span class="mx-2">|</span>
              <span><%= product.sold %>+ vendidos</span>
            </div>
            
            <!-- Free Shipping Badge -->
            <% if (product.freeShipping) { %>
              <span class="text-xs text-green-700">
                Envío Gratis Disponible
              </span>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
  </div>
</section>

<!-- Categories Showcase -->
<section class="py-8 bg-white">
  <div class="container mx-auto px-4">
    <h2 class="text-2xl font-bold mb-6">Categorías Populares</h2>
    
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
      <% featuredCategories.forEach(category => { %>
        <a href="#" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mb-2">
            <i class="fas fa-<%= category.icon %> text-red-600"></i>
          </div>
          <span class="text-sm text-center"><%= category.name %></span>
        </a>
      <% }); %>
    </div>
  </div>
</section>

<!-- Just For You Section (Main Products Grid) -->
<section class="py-8 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Solo para ti</h2>
      
      <!-- Sort options -->
      <div class="flex items-center">
        <label for="sort" class="text-sm text-gray-600 mr-2">Ordenar por:</label>
        <select id="sort" onchange="window.location.href = this.value"
              class="border rounded-md px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="/products?<%= new URLSearchParams({ ...query, sort: 'default', page: 1 }).toString() %>"
            <%= sort === 'default' ? 'selected' : '' %>>Destacados</option>
          <option value="/products?<%= new URLSearchParams({ ...query, sort: 'price_asc', page: 1 }).toString() %>"
            <%= sort === 'price_asc' ? 'selected' : '' %>>Precio: Menor a mayor</option>
          <option value="/products?<%= new URLSearchParams({ ...query, sort: 'price_desc', page: 1 }).toString() %>"
            <%= sort === 'price_desc' ? 'selected' : '' %>>Precio: Mayor a menor</option>
          <option value="/products?<%= new URLSearchParams({ ...query, sort: 'newest', page: 1 }).toString() %>"
            <%= sort === 'newest' ? 'selected' : '' %>>Más recientes</option>
        </select>
      </div>
    </div>
    
    <% if (paginatedProducts.length === 0) { %>
      <div class="bg-white rounded-lg shadow-sm p-12 text-center">
        <div class="mb-4 text-gray-400">
          <i class="fas fa-search fa-3x"></i>
        </div>
        <h3 class="text-xl font-semibold mb-2">No se encontraron productos</h3>
        <p class="text-gray-500 mb-6">Intenta con otra categoría o elimina los filtros aplicados.</p>
        <a href="/products" class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors">
          Ver todos los productos
        </a>
      </div>
    <% } else { %>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4">
        <% paginatedProducts.forEach(product => { 
          const badges = getBadges();
          const hasDiscount = Math.random() > 0.6;
          const discountPercent = Math.floor(Math.random() * 50) + 10;
          const originalPrice = hasDiscount ? (product.price * (1 + (discountPercent/100))).toFixed(2) : null;
          const soldCount = Math.floor(Math.random() * 5000) + 100;
          const rating = (4 + Math.random()).toFixed(1);
          const hasProximoPrecio = Math.random() > 0.8;
          const freeShipping = Math.random() > 0.3;
          const minFreeShipping = Math.random() > 0.5 ? 40 : 80;
        %>
          <div class="bg-white overflow-hidden rounded-lg shadow-sm hover:shadow-md transition-all duration-300 flex flex-col h-full group relative">
            <!-- Product Image with Badges -->
            <div class="relative aspect-square overflow-hidden bg-gray-100">
              <a href="/product/<%= product.id %>">
                <img 
                  src="<%= product.image %>" 
                  alt="<%= product.name %>" 
                  class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                >
              </a>
              
              <!-- Discount badge -->
              <% if (hasDiscount) { %>
                <div class="absolute top-0 left-0 bg-red-600 text-white text-xs font-bold px-2 py-1">
                  -<%= discountPercent %>%
                </div>
              <% } %>
              
              <!-- Wishlist button -->
              <button onclick="addToWishlist('<%= product.id %>')" class="absolute top-2 right-2 bg-white bg-opacity-70 rounded-full p-2 hover:bg-opacity-100 transition-all">
                <i class="far fa-heart text-gray-600 hover:text-red-600"></i>
              </button>
              
              <!-- Add to cart button (circular) -->
              <button onclick="addToCart('<%= product.id %>')" class="absolute bottom-2 right-2 w-10 h-10 bg-white rounded-full shadow-md flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <i class="fas fa-shopping-cart text-gray-700"></i>
              </button>
            </div>
            
            <!-- Product Info -->
            <div class="p-3 flex-grow">
              <!-- Badges -->
              <% if (badges.length > 0) { %>
                <div class="flex flex-wrap gap-1 mb-1">
                  <% badges.forEach(badge => { %>
                    <span class="text-xs px-1.5 py-0.5 rounded <%= badge.class %>"><%= badge.type %></span>
                  <% }); %>
                </div>
              <% } %>
              
              <% if (product.brand) { %>
                <div class="mb-1">
                  <span class="text-xs text-gray-500"><%= product.brand %></span>
                </div>
              <% } %>
              
              <!-- Product Title -->
              <h3 class="text-sm leading-tight mb-2 line-clamp-2 h-10">
                <a href="/product/<%= product.id %>" class="hover:text-red-600"><%= product.name %></a>
              </h3>
              
              <!-- Pricing -->
              <div class="flex items-center">
                <span class="text-red-600 font-bold">S/ <%= product.price.toFixed(2) %></span>
                <% if (hasDiscount) { %>
                  <span class="ml-2 text-xs text-gray-500 line-through">S/ <%= originalPrice %></span>
                <% } %>
              </div>
              
              <!-- Próximo precio -->
              <% if (hasProximoPrecio) { %>
                <div class="flex items-center mt-1">
                  <span class="text-xs bg-red-100 text-red-600 px-1 py-0.5 rounded-sm">
                    <i class="fas fa-bolt mr-1"></i> Próximo precio PEN<%= (product.price * 1.2).toFixed(2) %>
                  </span>
                </div>
              <% } %>
              
              <!-- Shipping & Rating -->
              <div class="mt-2 flex items-center text-xs text-gray-500">
                <div class="flex items-center">
                  <i class="fas fa-star text-yellow-400"></i>
                  <span class="ml-1"><%= rating %></span>
                </div>
                <span class="mx-2">|</span>
                <span><%= formatNumber(soldCount) %>+ vendidos</span>
              </div>
              
              <!-- Free Shipping Badge -->
              <div class="mt-1">
                <% if (freeShipping) { %>
                  <span class="text-xs text-green-700">Envío gratis</span>
                <% } else { %>
                  <span class="text-xs text-green-700">Envío gratis a partir de PEN<%= minFreeShipping %></span>
                <% } %>
              </div>
              
              <!-- Seller Info -->
              <div class="mt-1 text-xs text-gray-500">
                Por <%= Math.random() > 0.5 ? 'GEN Z' : 'AliExpress Plaza' %>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
      
      <!-- Load More Button (AliExpress style) -->
      <% if (currentPage < totalPages) { %>
        <div class="mt-8 text-center">
          <a 
            href="/products?<%= new URLSearchParams({...query, page: currentPage + 1}).toString() %>" 
            class="inline-block px-8 py-3 border border-red-600 text-red-600 rounded-full hover:bg-red-50 transition-colors"
          >
            Cargar más
          </a>
        </div>
      <% } %>
      
      <!-- Pagination - Only show if user scrolls to bottom or clicks "View All" -->
      <div class="mt-8 flex justify-center" id="pagination" style="display: none;">
        <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
          <!-- Previous Page Button -->
          <% if (currentPage > 1) { %>
            <a 
              href="/products?<%= new URLSearchParams({...query, page: currentPage - 1}).toString() %>" 
              class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              <i class="fas fa-chevron-left"></i>
              <span class="sr-only">Anterior</span>
            </a>
          <% } else { %>
            <span class="relative inline-flex items-center px-3 py-2 rounded-l-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-500 cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
              <span class="sr-only">Anterior</span>
            </span>
          <% } %>
          
          <!-- Page Numbers -->
          <% 
          // Determine which page numbers to show
          let startPage = Math.max(1, currentPage - 2);
          let endPage = Math.min(totalPages, startPage + 4);
          
          if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
          }
          
          for (let i = startPage; i <= endPage; i++) { 
          %>
            <% if (i === currentPage) { %>
              <span class="relative inline-flex items-center px-4 py-2 border border-red-600 bg-red-600 text-sm font-medium text-white" aria-current="page">
                <%= i %>
              </span>
            <% } else { %>
              <a 
                href="/products?<%= new URLSearchParams({...query, page: i}).toString() %>" 
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
              >
                <%= i %>
              </a>
            <% } %>
          <% } %>
          
          <!-- Ellipsis if needed -->
          <% if (endPage < totalPages) { %>
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
              ...
            </span>
            <a 
              href="/products?<%= new URLSearchParams({...query, page: totalPages}).toString() %>" 
              class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              <%= totalPages %>
            </a>
          <% } %>
          
          <!-- Next Page Button -->
          <% if (currentPage < totalPages) { %>
            <a 
              href="/products?<%= new URLSearchParams({...query, page: currentPage + 1}).toString() %>" 
              class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
            >
              <i class="fas fa-chevron-right"></i>
              <span class="sr-only">Siguiente</span>
            </a>
          <% } else { %>
            <span class="relative inline-flex items-center px-3 py-2 rounded-r-md border border-gray-300 bg-gray-100 text-sm font-medium text-gray-500 cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
              <span class="sr-only">Siguiente</span>
            </span>
          <% } %>
        </nav>
      </div>
    <% } %>
  </div>
</section>

<style>
  /* Etiquetas de tipos de ofertas */
  .group:hover {
    z-index: 10;
    transform: translateY(-2px);
  }
  
  /* Badge styles */
  .badge-choice {
    border: 1px solid #e0e0e0;
    background-color: white;
    color: #333;
  }
  
  .badge-superoferta {
    background-color: #ff4747;
    color: white;
  }
  
  .badge-promo {
    background-color: #ff4747;
    color: white;
  }
  
  .badge-bigsave {
    background-color: #2e8ae6;
    color: white;
  }
</style>

<script>
  // Toggle mobile filters
  document.getElementById('filter-toggle')?.addEventListener('click', function() {
    const filtersSidebar = document.getElementById('filters-sidebar');
    filtersSidebar.classList.toggle('hidden');
  });
  
  // Add to cart function
  function addToCart(productId) {
    // Aquí puedes implementar la lógica para añadir al carrito
    fetch('/cart/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ productId }),
    })
    .then(response => response.json())
    .then(data => {
      // Mostrar notificación de éxito
      const notification = document.createElement('div');
      notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.innerHTML = 'Producto añadido al carrito';
      document.body.appendChild(notification);
      
      // Actualizar contador del carrito
      const cartCount = document.querySelector('.cart-count');
      if (cartCount) {
        cartCount.textContent = parseInt(cartCount.textContent || '0') + 1;
      }
      
      // Eliminar notificación después de 3 segundos
      setTimeout(() => {
        notification.remove();
      }, 3000);
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }
  
  // Add to wishlist function
  function addToWishlist(productId) {
    // Implementar lógica para añadir a favoritos
    fetch('/api/wishlist/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ productId }),
    })
    .then(response => response.json())
    .then(data => {
      // Mostrar notificación
      const notification = document.createElement('div');
      notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.innerHTML = 'Producto añadido a favoritos';
      document.body.appendChild(notification);
      
      // Eliminar notificación después de 3 segundos
      setTimeout(() => {
        notification.remove();
      }, 3000);
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }
  
  // Show pagination on scroll to bottom
  window.addEventListener('scroll', function() {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
      document.getElementById('pagination').style.display = 'flex';
    }
  });
  
  // Carousel navigation for Top Picks
  document.querySelector('.prev-btn')?.addEventListener('click', function() {
    // Implement carousel previous slide
    const container = this.closest('section').querySelector('.grid');
    container.scrollBy({ left: -container.offsetWidth, behavior: 'smooth' });
  });
  
  document.querySelector('.next-btn')?.addEventListener('click', function() {
    // Implement carousel next slide
    const container = this.closest('section').querySelector('.grid');
    container.scrollBy({ left: container.offsetWidth, behavior: 'smooth' });
  });
  
  // Lazy loading for images
  document.addEventListener('DOMContentLoaded', function() {
    const lazyImages = [].slice.call(document.querySelectorAll('img.lazy'));
    
    if ('IntersectionObserver' in window) {
      let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            let lazyImage = entry.target;
            lazyImage.src = lazyImage.dataset.src;
            lazyImage.classList.remove('lazy');
            lazyImageObserver.unobserve(lazyImage);
          }
        });
      });
      
      lazyImages.forEach(function(lazyImage) {
        lazyImageObserver.observe(lazyImage);
      });
    }
  });
</script>

<%- include('reusables/footer') %>